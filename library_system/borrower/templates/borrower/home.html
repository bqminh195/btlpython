{% extends "base.html" %}
{% block content %}

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-3" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

{% if overdue_loans %}
  <div class="alert alert-danger">
    ‚ö†Ô∏è B·∫°n ƒëang c√≥ {{ overdue_loans|length }} cu·ªën s√°ch qu√° h·∫°n ch∆∞a tr·∫£!
    <ul class="mt-2 mb-0">
      {% for loan in overdue_loans %}
      <li>
        <strong>{{ loan.book.title }}</strong> (h·∫°n tr·∫£: {{ loan.due_date|date:"d/m/Y" }})
      </li>
      {% endfor %}
    </ul>
    <div class="text-end mt-3">
      <a href="{% url 'borrower:my_penalties' %}" class="btn btn-outline-light border-danger text-danger fw-bold">
        üìã Xem chi ti·∫øt
      </a>
    </div>
  </div>
{% endif %}



 <!-- Ti√™u ƒë·ªÅ + n√∫t truy c·∫≠p danh s√°ch m∆∞·ª£n + phi·∫øu ph·∫°t -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>üìñ Th∆∞ vi·ªán s√°ch</h3>

  <div>
    <a href="{% url 'borrower:my_loans' %}" class="btn btn-primary me-2">
      üìö Danh s√°ch m∆∞·ª£n
    </a>
    <a href="{% url 'borrower:my_penalties' %}" class="btn btn-danger">
      üí∞ Phi·∫øu ph·∫°t
    </a>
    <a href="{% url 'borrower:check_requests' %}" class="btn btn-warning">
    üïí Check-in / Check-out
  </a>
  </div>
</div>



  <!-- S√°ch m·ªõi nh·∫•t -->
  <h5 class="mt-4 mb-3">‚ú® S√°ch m·ªõi nh·∫•t</h5>
  <div class="row">
    {% for book in new_books %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm">
          {% if book.cover %}
            <img src="{{ book.cover.url }}" class="card-img-top" alt="{{ book.title }}" style="height: 250px; object-fit: cover;">
          {% else %}
            <div class="text-center p-5 text-muted">Kh√¥ng c√≥ ·∫£nh</div>
          {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ book.title }}</h5>
            <p class="card-text mb-1"><strong>T√°c gi·∫£:</strong> {{ book.author }}</p>
            <p class="card-text mb-1"><strong>NƒÉm XB:</strong> {{ book.year|default:"Kh√¥ng r√µ" }}</p>
            {% if book.category %}
              <p class="card-text mb-1"><strong>Th·ªÉ lo·∫°i:</strong> {{ book.category }}</p>
            {% endif %}
            <p class="card-text mb-1"><strong>C√≤n l·∫°i:</strong> {{ book.available_copies }}/{{ book.total_copies }}</p>
            {% if book.description %}
              <p class="text-muted small">{{ book.description|truncatewords:20 }}</p>
            {% endif %}
          </div>
          <div class="card-footer text-end bg-white">
            {% if book.available_copies > 0 %}
              <a href="{% url 'borrower:confirm_borrow' book.id %}" class="btn btn-success btn-sm">M∆∞·ª£n</a>
            {% else %}
              <button class="btn btn-secondary btn-sm" disabled>H·∫øt s√°ch</button>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-muted">Ch∆∞a c√≥ s√°ch n√†o ƒë∆∞·ª£c th√™m g·∫ßn ƒë√¢y.</p>
    {% endfor %}
  </div>

  <hr>

  <!-- B·ªô l·ªçc & t√¨m ki·∫øm -->
  <form method="get" class="row g-2 align-items-center mb-4">
    <div class="col-md-4">
      <input type="text" name="q" value="{{ query }}" class="form-control" placeholder="üîç T√¨m ki·∫øm theo t√™n ho·∫∑c t√°c gi·∫£...">
    </div>

    <div class="col-md-3">
      <select name="category" class="form-select">
        <option value="">-- Th·ªÉ lo·∫°i --</option>
        {% for c in categories %}
          <option value="{{ c }}" {% if c == selected_category %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <select name="year" class="form-select">
        <option value="">-- NƒÉm XB --</option>
        {% for y in years %}
          <option value="{{ y }}" {% if y|stringformat:"s" == selected_year|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3 text-end">
      <button type="submit" class="btn btn-primary">L·ªçc</button>
      <a href="{% url 'borrower:borrower_home' %}" class="btn btn-secondary">ƒê·∫∑t l·∫°i</a>
    </div>
  </form>

  <!-- Danh s√°ch t·∫•t c·∫£ s√°ch -->
  <h5 class="mb-3">üìö T·∫•t c·∫£ s√°ch</h5>
  <div class="row">
    {% for book in page_obj %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm">
          {% if book.cover %}
            <img src="{{ book.cover.url }}" class="card-img-top" alt="{{ book.title }}" style="height: 250px; object-fit: cover;">
          {% else %}
            <div class="text-center p-5 text-muted">Kh√¥ng c√≥ ·∫£nh</div>
          {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ book.title }}</h5>
            <p class="card-text mb-1"><strong>T√°c gi·∫£:</strong> {{ book.author }}</p>
            <p class="card-text mb-1"><strong>NƒÉm XB:</strong> {{ book.year|default:"Kh√¥ng r√µ" }}</p>
            {% if book.category %}
              <p class="card-text mb-1"><strong>Th·ªÉ lo·∫°i:</strong> {{ book.category }}</p>
            {% endif %}
            <p class="card-text mb-1"><strong>C√≤n l·∫°i:</strong> {{ book.available_copies }}/{{ book.total_copies }}</p>
            {% if book.description %}
              <p class="text-muted small">{{ book.description|truncatewords:20 }}</p>
            {% endif %}
          </div>
          <div class="card-footer text-end bg-white">
            {% if book.available_copies > 0 %}
              <a href="{% url 'borrower:confirm_borrow' book.id %}" class="btn btn-success btn-sm">M∆∞·ª£n</a>

            {% else %}
              <button class="btn btn-secondary btn-sm" disabled>H·∫øt s√°ch</button>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <div class="alert alert-secondary text-center">Kh√¥ng t√¨m th·∫•y s√°ch n√†o.</div>
    {% endfor %}
  </div>

  <!-- Ph√¢n trang -->
  {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}">¬´ Tr∆∞·ªõc</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">¬´ Tr∆∞·ªõc</span></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}">{{ num }}</a>
            </li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_year %}&year={{ selected_year }}{% endif %}">Sau ¬ª</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Sau ¬ª</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>

{% endblock %}

#